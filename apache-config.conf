# Apache Virtual Host Configuration for West Wind Marine Electronics
# Copy this configuration to your Apache sites-available directory
# Example: /etc/apache2/sites-available/westwindmarineelectronics.com.conf

<VirtualHost *:80>
    ServerName westwindmarineelectronics.com
    ServerAlias www.westwindmarineelectronics.com
    DocumentRoot /var/www/westwindmarineelectronics.com/public
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName westwindmarineelectronics.com
    ServerAlias www.westwindmarineelectronics.com
    DocumentRoot /var/www/westwindmarineelectronics.com/dist/public
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/westwindmarineelectronics.com.crt
    SSLCertificateKeyFile /etc/ssl/private/westwindmarineelectronics.com.key
    SSLCertificateChainFile /etc/ssl/certs/westwindmarineelectronics.com.ca-bundle
    
    # Security Headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
    </IfModule>
    
    # Cache static assets
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 month"
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/gif "access plus 1 month"
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/pdf "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType application/x-javascript "access plus 1 month"
        ExpiresByType application/x-shockwave-flash "access plus 1 month"
        ExpiresByType image/x-icon "access plus 1 year"
        ExpiresDefault "access plus 7 days"
    </IfModule>
    
    # Proxy API requests to Node.js application
    ProxyPreserveHost On
    ProxyPass /api/ http://localhost:5000/api/
    ProxyPassReverse /api/ http://localhost:5000/api/
    
    # Proxy contact form submissions
    ProxyPass /contact http://localhost:5000/contact
    ProxyPassReverse /contact http://localhost:5000/contact
    
    # Serve static files directly from Apache
    <Directory "/var/www/westwindmarineelectronics.com/dist/public">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Handle client-side routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteRule . /index.html [L]
    </Directory>
    
    # Environment variables (alternative to .env file)
    # SetEnv EMAIL_USER "contact@westwindmarineelectronics.com"
    # SetEnv EMAIL_PASS "your-email-password"
    # SetEnv EMAIL_TO "info@westwindmarineelectronics.com"
    # SetEnv SMTP_HOST "mail.westwindmarineelectronics.com"
    # SetEnv SMTP_PORT "587"
    # SetEnv NODE_ENV "production"
    # SetEnv PORT "5000"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/westwindmarineelectronics.com_error.log
    CustomLog ${APACHE_LOG_DIR}/westwindmarineelectronics.com_access.log combined
</VirtualHost>

# Security Configuration
<IfModule mod_headers.c>
    # Remove server signature
    ServerTokens Prod
    ServerSignature Off
    
    # Prevent access to sensitive files
    <Files ~ "^\.env">
        Order allow,deny
        Deny from all
    </Files>
    
    <Files ~ "^\.htaccess">
        Order allow,deny
        Deny from all
    </Files>
    
    <Files ~ "^package\.json">
        Order allow,deny
        Deny from all
    </Files>
    
    <Files ~ "^tsconfig\.json">
        Order allow,deny
        Deny from all
    </Files>
</IfModule>